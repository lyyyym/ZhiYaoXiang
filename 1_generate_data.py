import json
import random

# ==========================================
# 1. 完整药品知识库 (内置)
# ==========================================
drug_db = [
  {
    "id": 1, "药品名称": "复方氨酚烷胺胶囊", "适应症": "适用于缓解普通感冒及流行性感冒引起的发热、头痛、四肢酸痛、打喷嚏、流鼻涕、鼻塞、咽痛等症状。",
    "用法用量": "口服。成人，一次1粒，一日2次。", "禁忌": "严重肝肾功能不全者禁用。", "注意事项": "用药期间不得饮酒..."
  },
  {
    "id": 2, "药品名称": "布洛芬缓释胶囊", "适应症": "用于缓解轻至中度疼痛如头痛、关节痛、偏头痛、牙痛、肌肉痛、神经痛、痛经。也用于普通感冒或流行性感冒引起的发热。",
    "用法用量": "口服。成人一次1粒，一日2次。", "禁忌": "1. 孕妇及哺乳期妇女禁用。2. 对阿司匹林过敏禁用...", "注意事项": "本品为对症治疗药，不宜长期或大量使用..."
  },
  {
    "id": 3, "药品名称": "连花清瘟胶囊", "适应症": "清瘟解毒，宣肺泄热。用于治疗流行性感冒属热毒袭肺证，症见发热、恶寒、肌肉酸痛、鼻塞流涕、咳嗽、头痛、咽干咽痛等。",
    "用法用量": "口服。一次4粒，一日3次。", "禁忌": "尚不明确（但风寒感冒者不适用）。", "注意事项": "忌烟、酒及辛辣、生冷、油腻食物..."
  },
  {
    "id": 4, "药品名称": "感冒清热颗粒", "适应症": "疏风散寒，解表清热。用于风寒感冒，头痛发热，恶寒身痛，鼻流清涕，咳嗽咽干。",
    "用法用量": "开水冲服。一次1袋，一日2次。", "禁忌": "尚不明确。", "注意事项": "糖尿病患者及有高血压、心脏病...应在医师指导下服用。"
  },
  {
    "id": 5, "药品名称": "复方甘草片", "适应症": "用于镇咳祛痰。",
    "用法用量": "口服或含化。一次3-4片，一日3次。", "禁忌": "对本品及酒精过敏者禁用，胃炎及胃溃疡患者慎用。", "注意事项": "本品含阿片粉，长期服用可能产生依赖性..."
  },
  {
    "id": 6, "药品名称": "氨溴索口服液", "适应症": "适用于痰液粘稠不易咳出者。",
    "用法用量": "口服。成人及12岁以上儿童，一次10ml，一日2次。", "禁忌": "对本品过敏者禁用。", "注意事项": "孕妇及哺乳期妇女慎用..."
  },
  {
    "id": 7, "药品名称": "蒙脱石散", "适应症": "用于成人及儿童急、慢性腹泻。",
    "用法用量": "口服。成人一次1袋，一日3次。", "禁忌": "尚不明确。", "注意事项": "出现便秘，可减少剂量继续服用。"
  },
  {
    "id": 8, "药品名称": "多潘立酮片", "适应症": "用于消化不良、腹胀、嗳气、恶心、呕吐。",
    "用法用量": "口服。成人一次1片，一日3次，饭前服用。", "禁忌": "嗜铬细胞瘤、乳癌、机械性肠梗阻...禁用。", "注意事项": "心脏病患者慎用..."
  },
  {
    "id": 9, "药品名称": "铝碳酸镁咀嚼片", "适应症": "用于胃酸过多引起的胃痛、胃灼热感（烧心）、反酸，及慢性胃炎。",
    "用法用量": "咀嚼服用。一次1-2片，一日3次。", "禁忌": "尚不明确。", "注意事项": "严重心肾功能不全者慎用..."
  },
  {
    "id": 10, "药品名称": "复方酮康唑发用洗剂", "适应症": "用于治疗和预防由马拉色菌引起的各种感染，如花斑癣、脂溢性皮炎和头皮糠疹。",
    "用法用量": "局部外用。搓揉3-5分钟后用清水冲洗。", "禁忌": "病毒性感染（如疱疹、水痘）禁用。", "注意事项": "孕妇及哺乳期妇女禁用。"
  },
  { "id": 11, "药品名称": "红霉素软膏", "适应症": "用于脓疱疮等化脓性皮肤病、小面积烧伤、溃疡面的感染。", "用法用量": "局部外用。一日2次。", "禁忌": "对红霉素过敏者禁用。", "注意事项": "避免接触眼睛及其他黏膜。" },
  { "id": 12, "药品名称": "克霉唑乳膏", "适应症": "用于体癣、股癣、手癣、足癣、花斑癣、头癣以及念珠菌性甲沟炎。", "用法用量": "外用。涂于洗净的患处，一日2-3次。", "禁忌": "对本品过敏者禁用。", "注意事项": "仅供外用，切忌口服。" },
  { "id": 13, "药品名称": "复方醋酸地塞米松乳膏", "适应症": "用于局限性瘙痒症、神经性皮炎、接触性皮炎、脂溢性皮炎以及慢性湿疹。", "用法用量": "外用。一日1-2次。", "禁忌": "真菌性或病毒性皮肤病禁用。", "注意事项": "不宜大面积、长期使用。" },
  { "id": 14, "药品名称": "乌鸡白凤丸", "适应症": "补气养血，调经止带。用于气血两虚，身体瘦弱，腰膝酸软，月经不调。", "用法用量": "口服。一次1丸，一日2次。", "禁忌": "孕妇禁用；感冒发热病人不宜服用。", "注意事项": "服药期间忌食辛辣、生冷食物。" },
  { "id": 15, "药品名称": "维生素C片", "适应症": "用于预防和治疗坏血病，以及各种急、慢性传染病恢复期辅助治疗。", "用法用量": "口服。成人一次1片，一日3次。", "禁忌": "尚不明确。", "注意事项": "不宜长期过量服用。" },
  { "id": 16, "药品名称": "创可贴", "适应症": "用于小面积创伤、擦伤的止血护创。", "用法用量": "清洁伤口后，将创可贴胶带固定在伤口处。", "禁忌": "尚不明确", "注意事项": "一次性使用。" },
  { "id": 17, "药品名称": "电子体温计", "适应症": "用于测量人体体温。", "用法用量": "消毒探头后，置于腋下或口腔。", "禁忌": "无", "注意事项": "使用前后请用酒精棉片消毒。" },
  { "id": 18, "药品名称": "75%酒精消毒液", "适应症": "用于皮肤消毒，预防感染。", "用法用量": "涂擦于皮肤表面。", "禁忌": "对酒精过敏者慎用。", "注意事项": "本品易燃，远离火源。" },
  { "id": 19, "药品名称": "碘伏", "适应症": "用于皮肤消毒、粘膜冲洗，以及化脓性皮炎、皮肤真菌感染的消毒。", "用法用量": "外用。直接涂擦于患处。", "禁忌": "对碘过敏者慎用。", "注意事项": "避免与红药水同用。" },
  { "id": 20, "药品名称": "云南白药气雾剂", "适应症": "活血散瘀，消肿止痛。用于跌打损伤，淤血肿痛，肌肉酸痛。", "用法用量": "外用。喷于伤患处。一日3-5次。", "禁忌": "孕妇禁用；皮肤破损处禁用。", "注意事项": "切勿喷入眼内。" },
  { "id": 21, "药品名称": "奥美拉唑肠溶胶囊", "适应症": "用于胃酸过多引起的烧心、反酸、胃痛，也可用于胃溃疡。", "用法用量": "口服。一次1粒，一日1次，清晨服用。", "禁忌": "对本品过敏者禁用。", "注意事项": "必须整粒吞服，不可嚼碎。" },
  { "id": 22, "药品名称": "多酶片", "适应症": "用于消化不良、食欲缺乏。", "用法用量": "口服。一次1-2片，一日3次，饭前服用。", "禁忌": "对猪、牛源性蛋白过敏者禁用。", "注意事项": "不可与酸性药物同服；应整片吞服。" },
  { "id": 23, "药品名称": "保和丸", "适应症": "消食导滞，和胃。用于食积停滞，脘腹胀满，嗳气吞酸，食欲不振。", "用法用量": "口服。一次1-2丸，一日2次。", "禁忌": "孕妇慎用。", "注意事项": "忌食生冷、油腻、不易消化食物。" },
  { "id": 24, "药品名称": "复合维生素B片", "适应症": "用于预防和治疗B族维生素缺乏所致的营养不良、厌食、脚气病等。", "用法用量": "口服。一次1片，一日3次。", "禁忌": "对本品过敏者禁用。", "注意事项": "饭后服用。" },
  { "id": 25, "药品名称": "维生素AD滴剂", "适应症": "用于预防和治疗维生素A及D缺乏症，如佝偻病、夜盲症。", "用法用量": "口服。成人一次1粒，一日1次。", "禁忌": "慢性肾功能衰竭、高钙血症者禁用。", "注意事项": "不可超量。" },
  { "id": 26, "药品名称": "钙尔奇D钙片", "适应症": "用于妊娠、哺乳期妇女、更年期妇女、老年人等的钙补充。", "用法用量": "口服。一次1片，一日1-2次，饭后服用。", "禁忌": "高钙血症、肾结石患者禁用。", "注意事项": "心肾功能不全者慎用。" },
  { "id": 27, "药品名称": "逍遥丸", "适应症": "疏肝健脾，养血调经。用于肝郁脾虚所致的郁闷不舒、胸胁胀痛、头晕目眩、月经不调。", "用法用量": "口服。一次1袋，一日2次。", "禁忌": "孕妇慎用。", "注意事项": "感冒时不宜服用。" },
  { "id": 28, "药品名称": "妇科千金片", "适应症": "清热除湿，益气化瘀。用于湿热瘀阻所致的带下病、腹痛。", "用法用量": "口服。一次4片，一日3次。", "禁忌": "孕妇禁用。", "注意事项": "气滞血瘀、寒凝血瘀者慎用。" },
  { "id": 29, "药品名称": "花红片", "适应症": "清热解毒，燥湿止带。用于湿热瘀滞所致的带下病、月经不调、痛经。", "用法用量": "口服。一次4-5片，一日3次。", "禁忌": "孕妇禁用。", "注意事项": "糖尿病患者慎用。" },
  { "id": 30, "药品名称": "乳癖消片", "适应症": "软坚散结，活血消痛。用于痰热互结所致的乳癖、乳痈（乳房结节、胀痛）。", "用法用量": "口服。一次3片，一日3次。", "禁忌": "孕妇禁用。", "注意事项": "定期复查乳腺情况。" },
  { "id": 31, "药品名称": "对乙酰氨基酚片", "适应症": "用于普通感冒或流行性感冒引起的发热，及缓解轻至中度疼痛。", "用法用量": "口服。成人一次1片，间隔4-6小时。", "禁忌": "严重肝肾功能不全者禁用。", "注意事项": "不得与其他含有对乙酰氨基酚的药物同服；饮酒期间禁用。" },
  { "id": 32, "药品名称": "双氯芬酸钠缓释片", "适应症": "用于缓解类风湿关节炎、骨关节炎、痛风性关节炎及肌肉痛。", "用法用量": "口服。一次1片，一日1次，整片吞服。", "禁忌": "活动性消化道溃疡/出血患者禁用。", "注意事项": "避免与其他NSAIDs合用。" },
  { "id": 33, "药品名称": "蛇胆川贝液", "适应症": "祛风止咳，除痰散结。用于风热咳嗽、痰多气喘。", "用法用量": "口服。成人一次10ml，一日2次。", "禁忌": "对本品过敏者禁用。", "注意事项": "糖尿病患者慎用（含糖）。" },
  { "id": 34, "药品名称": "急支糖浆", "适应症": "清热化痰，宣肺止咳。用于急性支气管炎、感冒后咳嗽。", "用法用量": "口服。成人一次20ml，一日3次。", "禁忌": "孕妇禁用；糖尿病患者禁用。", "注意事项": "忌烟、酒及辛辣食物。" },
  { "id": 35, "药品名称": "川贝枇杷膏", "适应症": "清热润肺，止咳平喘。用于风热犯肺或燥邪伤肺所致的咳嗽、痰多、咽痛。", "用法用量": "口服。一次10ml，一日3次。", "禁忌": "糖尿病患者禁用。", "注意事项": "风寒咳嗽者不适用。" },
  { "id": 36, "药品名称": "通宣理肺丸", "适应症": "解表散寒，宣肺止咳。用于风寒感冒所致的咳嗽、发热、怕冷无汗。", "用法用量": "口服。一次1丸，一日2-3次。", "禁忌": "孕妇慎用。", "注意事项": "风热咳嗽者不适用。" },
  { "id": 37, "药品名称": "清开灵颗粒", "适应症": "清热解毒，镇静安神。用于外感风热时毒、高热不退、咽喉肿痛。", "用法用量": "开水冲服。一次1-2袋，一日2-3次。", "禁忌": "孕妇、哺乳期妇女禁用。", "注意事项": "风寒感冒者不适用；脾胃虚寒者慎用。" },
  { "id": 38, "药品名称": "板蓝根颗粒", "适应症": "清热解毒，凉血利咽。用于肺胃热盛所致的咽喉肿痛、急性扁桃体炎。", "用法用量": "开水冲服。一次1袋，一日3-4次。", "禁忌": "对本品过敏者禁用。", "注意事项": "风寒感冒者不适用。" },
  { "id": 39, "药品名称": "银翘解毒片", "适应症": "辛凉解表，清热解毒。用于风热感冒，发热、头痛、咳嗽、口干、咽痛。", "用法用量": "口服。一次4片，一日2-3次。", "禁忌": "对本品过敏者禁用。", "注意事项": "风寒感冒者不适用。" },
  { "id": 40, "药品名称": "感冒灵颗粒", "适应症": "解热镇痛。用于感冒引起的头痛、发热、鼻塞、流涕、咽痛。", "用法用量": "开水冲服。一次1袋，一日3次。", "禁忌": "严重肝肾功能不全者禁用。", "注意事项": "服药期间不得驾驶机、车、船；不得饮酒。" },
  { "id": 41, "药品名称": "炉甘石洗剂", "适应症": "用于急性瘙痒性皮肤病，如荨麻疹、痱子、湿疹、虫咬皮炎。", "用法用量": "外用。一日2-3次，涂于患处。", "禁忌": "对本品过敏者禁用。", "注意事项": "不得用于有渗出液的皮肤损害。" },
  { "id": 42, "药品名称": "莫匹罗星软膏", "适应症": "用于脓疱病、疖肿、毛囊炎等原发性皮肤感染。", "用法用量": "局部外用。一日2-3次。", "禁忌": "对本品过敏者禁用。", "注意事项": "避免接触眼睛。" },
  { "id": 43, "药品名称": "丁酸氢化可的松乳膏", "适应症": "用于过敏性皮炎、脂溢性皮炎、湿疹、神经性皮炎、皮肤瘙痒症。", "用法用量": "外用。一日2次。", "禁忌": "真菌、病毒性皮肤感染禁用。", "注意事项": "不宜大面积、长期使用。" },
  { "id": 44, "药品名称": "风油精", "适应症": "清凉，止痛，驱风，止痒。用于蚊虫叮咬、伤风感冒引起的头痛、晕车。", "用法用量": "外用。涂于太阳穴或患处。", "禁忌": "皮肤破损处禁用。", "注意事项": "孕妇及哺乳期妇女慎用。" },
  { "id": 45, "药品名称": "麝香壮骨膏", "适应症": "镇痛，消炎。用于风湿痛、关节痛、神经痛、扭伤。", "用法用量": "外用。贴于患处。", "禁忌": "孕妇禁用；开放性伤口禁用。", "注意事项": "皮肤过敏者慎用。" },
  { "id": 46, "药品名称": "聚维酮碘溶液(碘伏)", "适应症": "用于皮肤、黏膜的消毒，烫伤、擦伤、刀伤消毒。", "用法用量": "外用。直接涂擦。", "禁忌": "对碘过敏者禁用。", "注意事项": "不得与红药水同时使用。" },
  { "id": 47, "药品名称": "医用纱布块", "适应症": "用于创面覆盖、包扎、保护。", "用法用量": "清洁创面后覆盖。", "禁忌": "无", "注意事项": "一次性使用。" },
  { "id": 48, "药品名称": "一次性使用无菌注射器", "适应症": "用于皮下、肌肉、静脉注射给药。", "用法用量": "按临床规范操作。", "禁忌": "包装破损禁用。", "注意事项": "按医疗废物处理。" },
  { "id": 49, "药品名称": "水银体温计", "适应症": "用于测量人体体温。", "用法用量": "消毒后置于腋下或口腔。", "禁忌": "无", "注意事项": "避免剧烈震动；防止破碎。" },
  { "id": 50, "药品名称": "医用棉签", "适应症": "用于皮肤消毒、伤口清洁、涂抹药液。", "用法用量": "蘸取药液擦拭。", "禁忌": "包装破损禁用。", "注意事项": "一次性使用。" }
]

# ==========================================
# 2. 生成逻辑配置
# ==========================================
dataset = []
SYSTEM_PROMPT = "你是一个无人售药机的智能药师助手。请严格基于给定的【参考资料】回答用户问题。如果资料中提及禁忌症或库存缺货，必须发出警告或拒绝。"

def format_user_input(context_str, query):
    return f"请参考以下药品信息回答问题：\n### 参考信息开始 ###\n{context_str}\n### 参考信息结束 ###\n\n用户的具体问题是：\n{query}"

def format_drug_context(drug, stock_status="充足"):
    return f"""ID: {drug['id']}
药品名称：{drug['药品名称']}
适应症：{drug.get('适应症', '见说明书')}
用法用量：{drug.get('用法用量', '见说明书')}
禁忌：{drug.get('禁忌', '尚不明确')}
注意事项：{drug.get('注意事项', '尚不明确')}
库存状态：{stock_status}"""

# 模板库
symptom_queries = ["我感觉{symptom}，有什么药推荐吗？", "最近{symptom}，难受，机器里有药吗？", "治疗{symptom}买什么好？", "有没有治{symptom}的药？", "我{symptom}，急需买药。"]
usage_queries = ["{drug}怎么用？", "{drug}的用法是什么？", "{drug}一次用多少？", "{drug}有什么副作用？", "说明书上{drug}怎么用的？"]
safety_queries = ["我有{condition}，能用{drug}吗？", "我是{condition}患者，{drug}会有影响吗？", "听说{drug}对{condition}不好，是真的吗？"]

# ==========================================
# 3. 批量生成核心循环
# ==========================================
for drug in drug_db:
    name = drug['药品名称']
    indic = drug.get('适应症', '')
    contra = drug.get('禁忌', '尚不明确')
    caution = drug.get('注意事项', '尚不明确')
    usage = drug.get('用法用量', '遵医嘱')
    context = format_drug_context(drug)

    # --- 场景 A：症状推荐 (生成 3 条) ---
    if indic:
        import re
        # 智能分词，提取症状
        raw_syms = re.split(r'[，,。、\s]', indic)
        # 过滤掉无效词
        valid_syms = [s.strip() for s in raw_syms if len(s) > 1 and s not in ["用于", "治疗", "缓解", "症见", "以及", "引起", "所致"]]
        
        for sym in valid_syms[:3]: # 每个药取前3个症状生成问答
            query = random.choice(symptom_queries).format(symptom=sym)
            user_msg = format_user_input(context, query)
            ans = f"根据参考资料，针对“{sym}”，推荐您购买 **{name}**。\n\n**适应症**：{indic}\n**用法**：{usage}\n**库存**：充足。"
            dataset.append({"messages": [{"role": "system", "content": SYSTEM_PROMPT}, {"role": "user", "content": user_msg}, {"role": "assistant", "content": ans}]})

    # --- 场景 B：用法查询 (生成 2 条) ---
    for _ in range(2):
        query = random.choice(usage_queries).format(drug=name)
        user_msg = format_user_input(context, query)
        ans = f"关于 **{name}** 的信息如下：\n\n**用法用量**：{usage}\n**禁忌**：{contra}\n**注意事项**：{caution}\n请严格按照说明书使用。"
        dataset.append({"messages": [{"role": "system", "content": SYSTEM_PROMPT}, {"role": "user", "content": user_msg}, {"role": "assistant", "content": ans}]})

    # --- 场景 C：安全检查 (自动检测禁忌) ---
    risk_map = {"孕妇": ["孕妇", "怀孕"], "驾驶": ["开车", "驾驶"], "糖尿病": ["糖尿病", "血糖高"], "过敏": ["过敏体质"], "肝肾": ["肝肾功能不全"]}
    combined_risk_text = str(contra) + str(caution)
    
    for key, keywords in risk_map.items():
        if any(k in combined_risk_text for k in keywords):
            query = random.choice(safety_queries).format(condition=keywords[0], drug=name)
            user_msg = format_user_input(context, query)
            ans = f"**警告**：根据说明书，{keywords[0]} **{name}** 可能存在风险。\n\n参考资料指出：\n- 禁忌：{contra}\n- 注意事项：{caution}\n\n为了您的安全，建议咨询医生或不要购买。"
            dataset.append({"messages": [{"role": "system", "content": SYSTEM_PROMPT}, {"role": "user", "content": user_msg}, {"role": "assistant", "content": ans}]})

# --- 场景 D：负样本 (无药/不对症) ---
for _ in range(20):
    drug = random.choice(drug_db)
    context = format_drug_context(drug)
    fake_symptom = random.choice(["骨折", "癌症", "近视手术", "艾滋病", "洗牙"])
    query = f"我{fake_symptom}了，有药吗？"
    user_msg = format_user_input(context, query)
    ans = f"抱歉，根据提供的参考资料（{drug['药品名称']}），没有发现治疗“{fake_symptom}”的药物。\n\n本机可能没有相关库存，建议前往医院处理。"
    dataset.append({"messages": [{"role": "system", "content": SYSTEM_PROMPT}, {"role": "user", "content": user_msg}, {"role": "assistant", "content": ans}]})

# --- 场景 E：身份认知 ---
identity_qa = [
    ("你是谁？", "我是无人售药机的智能助手，基于Qwen2.5模型打造，可以帮您查询药品和库存。"),
    ("你能做什么？", "我可以根据您的症状推荐本机库存的药品，或者解答关于药品用法、禁忌的疑问。"),
    ("怎么买药？", "您告诉我需要的药品或症状，确认后我会告诉您货道号，您支付后即可出货。")
]
for q, a in identity_qa:
    dataset.append({"messages": [{"role": "system", "content": SYSTEM_PROMPT}, {"role": "user", "content": q}, {"role": "assistant", "content": a}]})

# ==========================================
# 4. 保存文件
# ==========================================
random.shuffle(dataset)
output_file = 'medical_rag_finetune_data.jsonl'
with open(output_file, 'w', encoding='utf-8') as f:
    for entry in dataset:
        json.dump(entry, f, ensure_ascii=False)
        f.write('\n')

print(f"成功生成 {len(dataset)} 条数据，已保存至 {output_file}")